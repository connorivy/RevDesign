{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <title>RevDesign</title>

        <!-- Bootstrap CSS CDN -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
        <!-- Our Custom CSS -->
        <link rel="stylesheet" href="{% static 'model/main.css' %}">
        <!-- Scrollbar Custom CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
        <!-- Font Awesome JS -->
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
        <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>
    </head>

    <body>
        <header class="site-header py-0">
            <nav class="navbar navbar-expand-lg navbar-dark bg-steel py-0" id="top_navbar">
                <!-- <a class="navbar-brand" href="#">Navbar</a> -->
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
                </button>
              
                <div class="collapse navbar-collapse py-0" id="navbarSupportedContent">
                  <ul class="navbar-nav mr-auto">
                    <li class="nav-item navbar-first">
                        <a class="nav-link py-0" href="#">File<span class="sr-only"></span></a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link py-0" href="#">Codes<span class="sr-only"></span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link py-0" href="#">Materials<span class="sr-only"></span></a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link py-0" href="#">Loads</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link py-0" href="#">Link</a>
                    </li>
                    <li class="nav-item dropdown">
                      <a class="nav-link dropdown-toggle py-0" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Dropdown
                      </a>
                      <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Something else here</a>
                      </div>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link disabled py-0" href="#">Disabled</a>
                    </li>
                  </ul>
                </div>
            </nav>
            <nav class="navbar navbar-expand-lg navbar-light bg-light py-4" id="bot_navbar" style="display: none;">
                <a class="navbar-brand" href="#">jBeam</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
                </button>
              
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                      <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" href="#">Link</a>
                    </li>
                    <li class="nav-item dropdown">
                      <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Add Load
                      </a>
                      <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Point</a>
                        <a class="dropdown-item" href="#">Distributed</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Something else here</a>
                      </div>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link disabled" href="#">Disabled</a>
                    </li>
                  </ul>
                  <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-dark my-2 my-sm-0" type="submit">Search</button>
                  </form>
                </div>
            </nav>
            <nav class="navbar navbar-expand-lg navbar-light bg-light py-4" id="bot_navbar"> 
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <button onclick="v.unloadAll()">Dispose Everything</button>
                    </li>
                    <li class="nav-item">
                        <button onclick="v.toggleCameraProjection()">Ortho/Perspective</button>
                    </li>
                    <li class="nav-item dropdown">
                      <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        View
                      </a>
                      <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <button onclick="v.interactions.rotateTo()">3D</button>
                        <button onclick="v.interactions.rotateTo('front')">Front</button>
                        <button onclick="v.interactions.rotateTo('back')">Back</button>
                        <button onclick="v.interactions.rotateTo('left')">Left</button>
                        <button onclick="v.interactions.rotateTo('right')">Right</button>
                      </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown2" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Analytics
                        </a>
                        <div class="dropdown-menu">
                            Used Memory (MB): <span id="info-mem">-</span> /
                            LoadProgress: <span id="info-progress">-</span> /
                            ViewerBusy: <span id="info-busy">idle</span> /
                            Draw Calls: <span id="info-draws">-</span>
                        </div>
                    </li>
                    <li class="nav-item">
                        <button onclick="getFloorMesh()">Get Mesh</button>
                    </li>
                    <form class="form-inline my-2 my-lg-0">
                        <!-- Distribution of different sized shear walls -->
                        <!-- <input id="objectUrlInput" class="form-control mr-sm-2" type="search" placeholder="Object URL" aria-label="Object URL" size="80" value="https://speckle.xyz/streams/218b84525a/objects/484aa60e78c3cd4854e4dc140e46b672"> -->
                        <!-- Simply Supported Example -->
                        <!-- <input id="objectUrlInput" class="form-control mr-sm-2" type="search" placeholder="Object URL" aria-label="Object URL" size="80" value="https://speckle.xyz/streams/218b84525a/objects/4c1e4775e1089970482ac754351eeff5"> -->
                        <!-- Cantilever Example -->
                        <input id="objectUrlInput" class="form-control mr-sm-2" type="search" placeholder="Object URL" aria-label="Object URL" size="80" value="https://speckle.xyz/streams/218b84525a/objects/f818a5e2d060a71092ab41cd765014d0">
                        <!-- Slab with walls on edges -->
                        <!-- <input id="objectUrlInput" class="form-control mr-sm-2" type="search" placeholder="Object URL" aria-label="Object URL" size="80" value="https://speckle.xyz/streams/218b84525a/objects/1c39e8c211b11b4c508947a99a03e77c"> -->
                        <!-- TB Floor1 -->
                        <!-- <input id="objectUrlInput" class="form-control mr-sm-2" type="search" placeholder="Object URL" aria-label="Object URL" size="80" value="https://speckle.xyz/streams/9250125033/objects/6fa3832f10f42f4b46a7acd66fe5e3d5"> -->
                        <button class="btn btn-outline-dark my-2 my-sm-0" type="submit" onclick="loadData()">Load</button>
                    </form>
                </div>
            </nav>
        </header>
        <!-- <header class="site-header">
            <nav class="navbar navbar-expand-md navbar-dark bg-steel fixed-top">
            <div class="container">
                <a class="navbar-brand mr-4" href="{% url 'model-home' %}">RevDesign</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggle" aria-controls="navbarToggle" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarToggle">
                <div class="navbar-nav mr-auto">
                    <a class="nav-item nav-link" href="{% url 'analysis-vue_test' %}">Analysis</a>
                    <a class="nav-item nav-link" href="{% url 'analysis-vue_test' %}">Beam</a>
                </div>

                <div class="navbar-nav">
                    <a class="nav-item nav-link" href="#">Login</a>
                    <a class="nav-item nav-link" href="#">Register</a>
                </div>
                </div>
            </div>
            </nav>
        </header> -->

        <div class="wrapper">
        <!-- Sidebar  -->
            <nav id="sidebar">
                <div class="sidebar-header">
                    <h3>Bootstrap Sidebar</h3>
                </div>

                <ul class="list-unstyled components">
                    <p>Dummy Heading</p>
                    <li class="active">
                        <a href="#homeSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Home</a>
                        <ul class="collapse list-unstyled" id="homeSubmenu">
                            <li>
                                <a href="#">Home 1</a>
                            </li>
                            <li>
                                <a href="#">Home 2</a>
                            </li>
                            <li>
                                <a href="#">Home 3</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">About</a>
                    </li>
                    <li>
                        <a href="#pageSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Pages</a>
                        <ul class="collapse list-unstyled" id="pageSubmenu">
                            <li>
                                <a href="#">Page 1</a>
                            </li>
                            <li>
                                <a href="#">Page 2</a>
                            </li>
                            <li>
                                <a href="#">Page 3</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Portfolio</a>
                    </li>
                    <li>
                        <a href="#">Contact</a>
                    </li>
                </ul>

                <ul class="list-unstyled CTAs">
                    <li>
                        <a href="https://bootstrapious.com/tutorial/files/sidebar.zip" class="download">Download source</a>
                    </li>
                    <li>
                        <a href="https://bootstrapious.com/p/bootstrap-sidebar" class="article">Back to article</a>
                    </li>
                </ul>
            </nav>

            <!-- Page Content  -->
            <div id="content">
                <nav id="tabNavBar" class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container-fluid">

                        <button type="button" id="sidebarCollapse" class="btn btn-info">
                            <i class="fas fa-align-left"></i>
                            <!-- <span>Toggle Sidebar</span> -->
                        </button>
                        <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <i class="fas fa-align-justify"></i>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="nav navbar-nav ml-auto">
                                <li class="nav-item active">
                                    <a class="nav-link" href="#">Page</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Page</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Page</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Page</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <div id="threejs-container">
                </div>

            </div>
        </div>
    </div>

    <!-- {%  block threejs %} 

    {% endblock threejs %} -->

    <!-- jQuery CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <!-- jQuery Custom Scroller CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
    <!-- Custom THREE JS script -->
    <script type="text/javascript" src="{% static 'dist/viewer.js' %}"></script>
    <script type="text/javascript">
      $(document).ready(function () {
          $("#sidebar").mCustomScrollbar({
              theme: "minimal"
          });

          $('#sidebarCollapse').on('click', function () {
              $('#sidebar, #content').toggleClass('active');
              $('.collapse.in').toggleClass('in');
              $('a[aria-expanded=true]').attr('aria-expanded', 'false');
          });
      });

      function getFloorMesh() {
        if ( v.interactions.selectedObjectsUserData.length == 0 ) {
            console.log('No Floor Selected')
            return
        } else if ( v.interactions.selectedObjectsUserData.length > 1 ) {
            console.log( 'Too many objects selected')
            return
        } 
        var segments = v.interactions.selectedObjectsUserData[0].outline.segments;
        var coords = new Set();
        for (var i = 0; i < segments.length; i++) {
            coords.add(JSON.stringify([+(segments[i].start.x).toFixed(6), +(segments[i].start.y).toFixed(6)]))
            coords.add(JSON.stringify([+(segments[i].end.x).toFixed(6), +(segments[i].end.y).toFixed(6)]))
        }
        if (segments.length != coords.size) {
            console.log('WARNING: number of unique coordinates does not equal number of segments')
        }

        var coordArrayFloor = Array.from(coords, e => JSON.parse(e));
        // 'close polygon loop' in order for the points in poly function to work
        coordArrayFloor.push(coordArrayFloor[0])
        // console.log(coordArrayFloor)

        // get all shearwalls
        var coordArrayWalls = []
        var coordDictWalls = {}
        var p0x = false
        var p1x = false
        var p0y = false
        var p1y = false
        var p0inPoly = [false, null]
        var p1inPoly = [false, null]
        var p0IsCorner = false
        var p1IsCorner = false
        var distOfP0 = 0
        var distOfP1 = 0
        for (var i = 0; i < v.sceneManager.shearWalls.length; i++) {
            p0x = +v.sceneManager.shearWalls[i].userData.start.x.toFixed(6)
            p0y = +v.sceneManager.shearWalls[i].userData.start.y.toFixed(6)
            p1x = +v.sceneManager.shearWalls[i].userData.end.x.toFixed(6)
            p1y = +v.sceneManager.shearWalls[i].userData.end.y.toFixed(6)
            console.log('points of line', [p0x, p0y], [p1x, p1y])
            p0inPoly = pointInPolygon([p0x, p0y], [coordArrayFloor], 3)
            p1inPoly = pointInPolygon([p1x, p1y], [coordArrayFloor], 3)
            console.log('points in poly', p0inPoly, p1inPoly)
            // one or both of the points is outside the slab, don't count it.
            if (p0inPoly[0] === false || p1inPoly[0] === false) {
                console.log('outside slab')
                continue
            }
            // both points are inside the slab, yay
            if (p0inPoly[0] == true && p1inPoly[0] == true) {
                console.log('inside slab')
            // both points are on the border of the polygon
            } else if (p0inPoly[0] === 0 && p1inPoly[0] === 0) {
                console.log('on perim')
                p0IsCorner = isEqual2DList(coordArrayFloor[p0inPoly[1]],[p0x, p0y]) || isEqual2DList(coordArrayFloor[p0inPoly[1]+1],[p0x, p0y])
                p1IsCorner = isEqual2DList(coordArrayFloor[p1inPoly[1]],[p1x, p1y]) || isEqual2DList(coordArrayFloor[p1inPoly[1]+1],[p1x, p1y])

                // if both are corners, just add to coord array walls
                if (p0IsCorner && p1IsCorner) {} 
                else if (p0IsCorner) {
                    coordArrayFloor.splice(p1inPoly[1]+1, 0, [p1x, p1y])
                } else if (p1IsCorner) {
                    coordArrayFloor.splice(p0inPoly[1]+1, 0, [p0x, p0y])
                // neither point is on a corner
                } else {
                    // find the point that has the largest index in the list, insert there, and then insert the new point into the smaller index
                    if (p0inPoly[1] > p1inPoly[1]) {
                        coordArrayFloor.splice(p0inPoly[1]+1, 0, [p0x, p0y])
                        coordArrayFloor.splice(p1inPoly[1]+1, 0, [p1x, p1y])
                    } else if (p0inPoly[1] < p1inPoly[1]) {
                        coordArrayFloor.splice(p1inPoly[1]+1, 0, [p1x, p1y])
                        coordArrayFloor.splice(p0inPoly[1]+1, 0, [p0x, p0y])
                    // if the indicies are the same, then the points are on the same line. Find the one furthest away from the corner point and insert that right after the point,
                    // then insert the closer point right after the corner point in the coodArrayFloor
                    } else {
                        distOfP0 = distanceFormula([p0x, p0y], coordArrayFloor[p0inPoly[1]])
                        distOfP1 = distanceFormula([p1x, p1y], coordArrayFloor[p0inPoly[1]])
                        // if p0 is closer, insert p1 then p0
                        if (distOfP0 < distOfP1) {
                            coordArrayFloor.splice(p0inPoly[1]+1, 0, [p1x, p1y])
                            coordArrayFloor.splice(p0inPoly[1]+1, 0, [p0x, p0y])
                        } else {
                            coordArrayFloor.splice(p0inPoly[1]+1, 0, [p0x, p0y])
                            coordArrayFloor.splice(p0inPoly[1]+1, 0, [p1x, p1y])
                        }
                    }
                }
            } else if (p0inPoly[0] === 0) {
                console.log('p0 on perim')
                coordArrayFloor.splice(p0inPoly[1]+1, 0, [p0x, p0y])
            } else if (p1inPoly[0] === 0) {
                console.log('p1 on perim')
                coordArrayFloor.splice(p1inPoly[1]+1, 0, [p1x, p1y])
            }
            coordDictWalls[v.sceneManager.shearWalls[i].userData.id] = [
                p0x, 
                p0y, 
                p1x,
                p1y,
            ]
            // coordArrayWalls.push([
            //     p0x, 
            //     p0y, 
            //     p1x,
            //     p1y,
            // ])
        }

        // pop value added earlier to close loop. This is how sfepy pygmsh prefers it's polygons
        coordArrayFloor.pop()
        console.log(coordArrayFloor)
        // console.log(localStorage.getItem( 'prevLoadUrl' ), v.loaders[localStorage.getItem( 'prevLoadUrl' )].serverUrl, v.loaders[localStorage.getItem( 'prevLoadUrl' )].streamId)

        // POST request
        $.ajax({
            type: 'POST',
            url: "{% url 'get_floor_mesh' %}",
            data: {
                'coord_list_floor': JSON.stringify(coordArrayFloor),
                'coord_list_walls': JSON.stringify(coordArrayWalls),
                'coord_dict_walls': JSON.stringify(coordDictWalls),
                'HOST': v.loaders[localStorage.getItem( 'prevLoadUrl' )].serverUrl,
                'STREAM_ID': v.loaders[localStorage.getItem( 'prevLoadUrl' )].streamId,
                'COMMIT_ID': v.loaders[localStorage.getItem( 'prevLoadUrl' )].objectId,
                'FLOOR_ID': v.interactions.selectedObjectsUserData[0].id
            },
            success: function (response) {
                console.log(response)
            },
            error: function (response) {
                console.log('error')
                console.log(response)
            }
        })
    };

    function pointInPolygon(p, polygon, numDecimals) {
        let i = 0
        let ii = 0
        let k = 0
        let f = 0
        let u1 = 0
        let v1 = 0
        let u2 = 0
        let v2 = 0
        let currentP = null
        let nextP = null

        const x = +p[0].toFixed(numDecimals)
        const y = +p[1].toFixed(numDecimals)

        const numContours = polygon.length
        for (i; i < numContours; i++) {
            ii = 0
            const contourLen = polygon[i].length - 1
            const contour = polygon[i]

            currentP = contour[0]
            if (currentP[0] !== contour[contourLen][0] &&
                currentP[1] !== contour[contourLen][1]) {
                throw new Error('First and last coordinates in a ring must be the same')
            }

            u1 = +currentP[0].toFixed(numDecimals) - x
            v1 = +currentP[1].toFixed(numDecimals) - y

            for (ii; ii < contourLen; ii++) {
                nextP = contour[ii + 1]

                v2 = +nextP[1].toFixed(numDecimals) - y

                if ((v1 < 0 && v2 < 0) || (v1 > 0 && v2 > 0)) {
                    currentP = nextP
                    v1 = v2
                    u1 = +currentP[0].toFixed(numDecimals) - x
                    continue
                }

                u2 = +nextP[0].toFixed(numDecimals) - x

                if (v2 > 0 && v1 <= 0) {
                    f = (u1 * v2) - (u2 * v1)
                    if (f > 0) k = k + 1
                    else if (f === 0) return [0, ii]
                } else if (v1 > 0 && v2 <= 0) {
                    f = (u1 * v2) - (u2 * v1)
                    if (f < 0) k = k + 1
                    else if (f === 0) return [0, ii]
                } else if (v2 === 0 && v1 < 0) {
                    f = (u1 * v2) - (u2 * v1)
                    if (f === 0) return [0, ii]
                } else if (v1 === 0 && v2 < 0) {
                    f = u1 * v2 - u2 * v1
                    if (f === 0) return [0, ii]
                } else if (v1 === 0 && v2 === 0) {
                    if (u2 <= 0 && u1 >= 0) {
                        return [0, ii]
                    } else if (u1 <= 0 && u2 >= 0) {
                        return [0, ii]
                    }
                }
                currentP = nextP
                v1 = v2
                u1 = u2
            }
        }

        if (k % 2 === 0) return [false, null]
        return [true, null]
    }

    function isEqual2DList(p1, p2) {
        tol = 1e-1
        if (Math.abs(p2[0] - p1[0]) < tol && Math.abs(p2[1] - p1[1]) < tol) {
            return true
        } 
        return false
    }

    function distanceFormula(p0, p1) {
        return Math.sqrt((p0[0] - p1[0])**2 + (p0[1] - p1[1])**2)
    }
    </script>
  </body>
</html>